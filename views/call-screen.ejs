<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Screen</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // Make Peer available globally
        window.Peer = Peer;
    </script>
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .ringing-animation {
            animation: pulse 1.5s infinite;
        }
        #localVideo {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 1;
        }
        #remoteVideo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        .call-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 2;
        }
        .call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .call-control-btn:hover {
            transform: scale(1.1);
        }
        .end-call {
            background-color: #ef4444;
        }
        .toggle-video {
            background-color: #4b5563;
        }
        .toggle-audio {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900 h-screen">
    <!-- Audio elements for ring sounds -->
    <audio id="incomingRing" loop>
        <source src="/sounds/incoming-call.mp3" type="audio/mpeg">
    </audio>
    <audio id="outgoingRing" loop>
        <source src="/sounds/outgoing-call.mp3" type="audio/mpeg">
    </audio>

    <!-- Video elements -->
    <video id="localVideo" autoplay muted playsinline class="hidden"></video>
    <video id="remoteVideo" autoplay playsinline class="hidden"></video>
    <div class="overlay"></div>

    <!-- Call UI -->
    <div id="callUI" class="flex flex-col items-center justify-center h-screen text-white">
        <img id="callerAvatar" src="https://randomuser.me/api/portraits/women/2.jpg" alt="Caller" 
             class="w-32 h-32 rounded-full mb-6 border-4 border-white ringing-animation">
        <h2 id="callerName" class="text-4xl font-bold mb-2">Calling...</h2>
        <p id="callStatus" class="text-xl mb-8">Connecting...</p>

        <div id="callControls" class="flex space-x-8">
            <button id="rejectCall" class="flex flex-col items-center p-4 bg-red-600 rounded-full hover:bg-red-700 transition duration-300">
                <i class="fas fa-phone-slash text-2xl mb-1"></i>
                <span class="text-sm">Reject</span>
            </button>
            <button id="answerCall" class="flex flex-col items-center p-4 bg-green-600 rounded-full hover:bg-green-700 transition duration-300">
                <i class="fas fa-phone text-2xl mb-1"></i>
                <span class="text-sm">Answer</span>
            </button>
        </div>
    </div>

    <!-- Active call controls -->
    <div id="activeCallControls" class="call-controls hidden">
        <button id="toggleVideo" class="call-control-btn toggle-video">
            <i class="fas fa-video text-white text-2xl"></i>
        </button>
        <button id="toggleAudio" class="call-control-btn toggle-audio">
            <i class="fas fa-microphone text-white text-2xl"></i>
        </button>
        <button id="endCall" class="call-control-btn end-call">
            <i class="fas fa-phone-slash text-white text-2xl"></i>
        </button>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const currentUserId = localStorage.getItem('userId');
        const urlParams = new URLSearchParams(window.location.search);
        const isVideo = urlParams.get('video') === 'true';
        const isIncoming = urlParams.get('incoming') === 'true';
        
        // Initialize socket with authentication
        const socket = io({
            auth: { token },
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            timeout: 10000
        });

        let peer = null;
        let localStream = null;
        let remoteStream = null;
        let currentCall = null;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let remoteUserId = null;
        const incomingRing = document.getElementById('incomingRing');
        const outgoingRing = document.getElementById('outgoingRing');

        // Function to stop all ring sounds
        function stopAllRings() {
            incomingRing.pause();
            incomingRing.currentTime = 0;
            outgoingRing.pause();
            outgoingRing.currentTime = 0;
        }

        // Initialize WebRTC
        async function initializeCall(isVideo) {
            try {
                // Play outgoing ring sound
                outgoingRing.play().catch(error => console.log('Error playing outgoing ring:', error));

                // Get user media based on call type
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: isVideo,
                    audio: true
                });

                // Show/hide video elements based on call type
                const localVideo = document.getElementById('localVideo');
                const remoteVideo = document.getElementById('remoteVideo');
                const callUI = document.getElementById('callUI');
                const activeCallControls = document.getElementById('activeCallControls');

                if (isVideo) {
                    // For video calls
                    localVideo.srcObject = localStream;
                    localVideo.classList.remove('hidden');
                    remoteVideo.classList.remove('hidden');
                    callUI.classList.add('hidden');
                    activeCallControls.classList.remove('hidden');
                } else {
                    // For voice calls
                    localVideo.classList.add('hidden');
                    remoteVideo.classList.add('hidden');
                    callUI.classList.remove('hidden');
                    activeCallControls.classList.remove('hidden');
                    document.getElementById('callerAvatar').classList.add('ringing-animation');
                }

                // Initialize PeerJS with proper configuration
                peer = new Peer(undefined, {
                    host: window.location.hostname,
                    port: 3001,
                    path: '/',
                    debug: 3,
                    secure: window.location.protocol === 'https:',
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });

                peer.on('open', (id) => {
                    console.log('Peer connection opened with ID:', id);
                    socket.emit('join_call_room', id);
                });

                peer.on('error', (err) => {
                    console.error('PeerJS error:', err);
                    if (err.type === 'peer-unavailable') {
                        alert('The other user is not available for calls.');
                    } else {
                        alert('Error connecting to call server. Please try again.');
                    }
                    stopAllRings();
                    window.location.href = '/chat-window';
                });

                peer.on('call', (call) => {
                    console.log('Incoming call from peer:', call);
                    call.answer(localStream);
                    currentCall = call;

                    call.on('stream', (stream) => {
                        console.log('Received remote stream');
                        remoteStream = stream;
                        
                        if (isVideo) {
                            remoteVideo.srcObject = stream;
                            remoteVideo.classList.remove('hidden');
                        }
                        
                        // Update UI for connected state
                        document.getElementById('callStatus').textContent = 'Connected';
                        document.getElementById('callerAvatar').classList.remove('ringing-animation');
                        callUI.classList.add('hidden');
                        activeCallControls.classList.remove('hidden');
                    });

                    call.on('close', () => {
                        console.log('Call closed');
                        endCall();
                    });

                    call.on('error', (err) => {
                        console.error('Call error:', err);
                        endCall();
                    });
                });

                setupCallControls(isVideo);
            } catch (error) {
                console.error('Error initializing call:', error);
                alert('Error accessing camera/microphone');
                stopAllRings();
            }
        }

        // Setup call controls based on call type
        function setupCallControls(isVideo) {
            const toggleVideo = document.getElementById('toggleVideo');
            const toggleAudio = document.getElementById('toggleAudio');
            const endCall = document.getElementById('endCall');

            // Only show video toggle for video calls
            if (toggleVideo) {
                toggleVideo.style.display = isVideo ? 'flex' : 'none';
                toggleVideo.addEventListener('click', () => {
                    if (localStream) {
                        isVideoEnabled = !isVideoEnabled;
                        localStream.getVideoTracks().forEach(track => {
                            track.enabled = isVideoEnabled;
                        });
                        const icon = toggleVideo.querySelector('i');
                        icon.className = isVideoEnabled ? 'fas fa-video text-white text-2xl' : 'fas fa-video-slash text-white text-2xl';
                    }
                });
            }

            // Audio toggle for both call types
            if (toggleAudio) {
                toggleAudio.addEventListener('click', () => {
                    if (localStream) {
                        isAudioEnabled = !isAudioEnabled;
                        localStream.getAudioTracks().forEach(track => {
                            track.enabled = isAudioEnabled;
                        });
                        const icon = toggleAudio.querySelector('i');
                        icon.className = isAudioEnabled ? 'fas fa-microphone text-white text-2xl' : 'fas fa-microphone-slash text-white text-2xl';
                    }
                });
            }

            // End call button for both call types
            if (endCall) {
                endCall.addEventListener('click', () => {
                    stopAllRings();
                    endCall();
                });
            }
        }

        // End call
        function endCall() {
            stopAllRings();
            if (currentCall) {
                currentCall.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            socket.emit('end_call', { to: remoteUserId });
            window.location.href = '/chat-window';
        }

        // Handle incoming call
        socket.on('call_received', async ({ signal, from, name, isVideo }) => {
            console.log('Call received:', { signal, from, name, isVideo });
            
            // Play incoming ring sound
            incomingRing.play().catch(error => console.log('Error playing incoming ring:', error));

            // Update UI elements
            document.getElementById('callerName').textContent = name;
            document.getElementById('callStatus').textContent = 'Incoming call...';
            remoteUserId = from;

            // If it's a video call, show local video preview
            if (isVideo) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    document.getElementById('localVideo').srcObject = stream;
                } catch (error) {
                    console.error('Error accessing camera:', error);
                }
            }

            // Setup call control buttons
            document.getElementById('rejectCall').addEventListener('click', () => {
                stopAllRings();
                socket.emit('call_rejected', { to: from });
                window.location.href = '/chat-window';
            });

            document.getElementById('answerCall').addEventListener('click', async () => {
                stopAllRings();
                document.getElementById('callStatus').textContent = 'Connecting...';
                await initializeCall(isVideo);
                
                const call = peer.call(remoteUserId, localStream);
                currentCall = call;

                call.on('stream', (stream) => {
                    remoteStream = stream;
                    const remoteVideo = document.getElementById('remoteVideo');
                    remoteVideo.srcObject = stream;
                    remoteVideo.classList.remove('hidden');
                });

                socket.emit('answer_call', { to: from, signal: peer.signal(signal), isVideo });
            });
        });

        // Handle call accepted
        socket.on('call_accepted', ({ signal, isVideo }) => {
            console.log('Call accepted:', { signal, isVideo });
            stopAllRings();
            
            // Update UI elements
            document.getElementById('callStatus').textContent = 'Connected';
            document.getElementById('callerAvatar').classList.remove('ringing-animation');
            
            // Show/hide elements based on call type
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            const callUI = document.getElementById('callUI');
            const activeCallControls = document.getElementById('activeCallControls');
            const toggleVideo = document.getElementById('toggleVideo');

            if (isVideo) {
                localVideo.classList.remove('hidden');
                remoteVideo.classList.remove('hidden');
                callUI.classList.add('hidden');
                activeCallControls.classList.remove('hidden');
                if (toggleVideo) toggleVideo.style.display = 'flex';
            } else {
                localVideo.classList.add('hidden');
                remoteVideo.classList.add('hidden');
                callUI.classList.remove('hidden');
                activeCallControls.classList.remove('hidden');
                if (toggleVideo) toggleVideo.style.display = 'none';
            }
            
            // Check if peer is initialized before calling signal
            if (peer && typeof peer.signal === 'function') {
                peer.signal(signal);
            } else {
                console.error('Peer not initialized or signal function not available');
                alert('Error establishing call connection. Please try again.');
                window.location.href = '/chat-window';
            }
        });

        // Handle call ended
        socket.on('call_ended', () => {
            console.log('Call ended');
            stopAllRings();
            document.getElementById('callStatus').textContent = 'Call ended';
            endCall();
        });

        // Handle call rejected
        socket.on('call_rejected', () => {
            console.log('Call rejected');
            stopAllRings();
            document.getElementById('callStatus').textContent = 'Call rejected';
            setTimeout(() => {
                window.location.href = '/chat-window';
            }, 2000);
        });

        // Initialize call if starting a new call
        if (!isIncoming) {
            initializeCall(isVideo);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const isVideo = urlParams.get('video') === 'true';
            const isIncoming = urlParams.get('incoming') === 'true';

            // Initialize socket with authentication
            const token = localStorage.getItem('token');
            const socket = io({
                transports: ['websocket', 'polling'],
                auth: { token },
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                timeout: 10000
            });

            socket.on('connect', () => {
                console.log('Socket connected with ID:', socket.id);
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
            });

            if (isIncoming) {
                // Handle incoming call
                const incomingCallData = JSON.parse(localStorage.getItem('incomingCall') || '{}');
                const { signal, from, name, isVideo } = incomingCallData;

                // Update UI for incoming call
                document.getElementById('callerName').textContent = name;
                document.getElementById('callStatus').textContent = 'Incoming call...';
                document.getElementById('callerAvatar').classList.add('ringing-animation');

                // Play incoming ring sound
                const incomingRing = document.getElementById('incomingRing');
                if (incomingRing) {
                    incomingRing.play().catch(error => console.log('Error playing incoming ring:', error));
                }

                // Setup call control buttons
                document.getElementById('rejectCall').addEventListener('click', () => {
                    stopAllRings();
                    socket.emit('call_rejected', { to: from });
                    window.location.href = '/chat-window';
                });

                document.getElementById('answerCall').addEventListener('click', async () => {
                    stopAllRings();
                    document.getElementById('callStatus').textContent = 'Connecting...';
                    await initializeCall(isVideo);
                    
                    const call = peer.call(from, localStream);
                    currentCall = call;

                    call.on('stream', (stream) => {
                        remoteStream = stream;
                        const remoteVideo = document.getElementById('remoteVideo');
                        if (remoteVideo) {
                            remoteVideo.srcObject = stream;
                            remoteVideo.classList.remove('hidden');
                        }
                    });

                    socket.emit('answer_call', { to: from, signal: peer.signal(signal), isVideo });
                });

                // Clean up localStorage
                localStorage.removeItem('incomingCall');
            } else {
                // Handle outgoing call
                initializeCall(isVideo);
            }

            // Setup call event listeners
            socket.on('call_accepted', ({ signal, isVideo }) => {
                console.log('Call accepted:', { signal, isVideo });
                stopAllRings();
                document.getElementById('callStatus').textContent = 'Connected';
                document.getElementById('callerAvatar').classList.remove('ringing-animation');
                peer.signal(signal);
            });

            socket.on('call_ended', () => {
                console.log('Call ended');
                stopAllRings();
                document.getElementById('callStatus').textContent = 'Call ended';
                endCall();
            });

            socket.on('call_rejected', () => {
                console.log('Call rejected');
                stopAllRings();
                document.getElementById('callStatus').textContent = 'Call rejected';
                setTimeout(() => {
                    window.location.href = '/chat-window';
                }, 2000);
            });
        });
    </script>
</body>
</html> 